---
title: "Killing-Assay: Musterlösung"
author: "mariia"
format: 
  html: 
    embed-resources: true
editor: visual
---

## Plattenlayout

```{r}
suppressPackageStartupMessages( library(tidyverse) )

plate_cols <- tibble(
  plate_column = 1:12,
  used = c( FALSE, rep(TRUE, 10), FALSE ),
  content = c( "empty", rep( "co-culture", 8 ), rep( "target cells only", 2 ), "empty" ),
  subject = c( NA, rep( c( "C1", "P1", "C2", "C3" ), 2 ), rep( NA, 3 ) ),
  aphidicolin = c( NA, rep( TRUE, 9), FALSE, NA ),
  n0_target_cells = c( 0, rep( 12000, 10), 0 ),
  n0_t_cells = c( 0, rep( 12000, 4), rep( 24000, 4), rep( 0, 3 ) ),
)  
plate_cols
```

### Aufgabe

```{r}
plate_rows <- tibble(
  plate_row = LETTERS[1:8], 
  used = c(FALSE, rep(TRUE, 6), FALSE),
  conc_anti_cd3 = c(NA, 0, 0, 1, 1, 5, 5, NA)
)
plate_rows
```

## Daten

### Aufgabe

Die Daten wurden mithilfe eines Tabellenkalkulationsprogramms inspiziert. Die Datei enthält in den ersten sechs Zeilen Metadaten zur Messung; anschließend folgen zeilenweise kommagetrennte Werte (CSV). Die erste Spalte enthält Informationen zum Datum und zur Uhrzeit der Messung, die zweite Spalte ("Elapsed") entspricht der Inkubationszeit. Jede weitere Spalte bezieht sich auf ein einzelnes Well (mit jeweils vier Replikaten) und enthält die Anzahl der detektierten Zellen.

```{r}
read_delim( "GFP_object_count_perImage20221020withIL2.txt", 
    delim="\t", skip=6, local=locale(decimal_mark=",") ) -> table_raw

table_raw
```

### Aufgabe

Die Tabelle wird in ein langes Format umgeformt:

```{r}
table_raw %>%
  select(-"Date Time") %>% #irrelevant
  pivot_longer(cols = - Elapsed, names_to = "name", values_to = "count") %>%
  rename(hours_incub = Elapsed) -> tbl_intermediate
tbl_intermediate
```

```{r}
tbl_intermediate %>% 
mutate( matches = as_tibble( str_match( name, "(.)(..?), Image (.)" ) ) ) %>% 
unnest( matches ) %>% 
select( hours_incub, plate_row = V2, plate_column = V3, image_no = V4, count ) %>%
mutate( image_no = as.integer(image_no) )  %>%
mutate( plate_column = as.integer(plate_column) ) -> tbl_long

tbl_long
```

### Aufgabe

Die Zellzahlen der vier Replikate werden aufaddiert:

```{r}
tbl_long %>%
  group_by( hours_incub, plate_row, plate_column ) %>%
  summarize( count = sum(count) ) -> counts_per_well
counts_per_well
```

## Monokulturen

### Aufgabe

Wir betrachten die Dynamik der Targetzell-Monokulturen.

```{r}
counts_per_well %>%
  left_join( plate_rows, by = "plate_row" ) %>%
  left_join( plate_cols, by = "plate_column") %>%
  filter( 
    content == "target cells only",
    used = TRUE
    ) %>%
  mutate( well = str_c( plate_row, plate_column ) ) %>%
  mutate( conc_anti_cd3 = as.factor(conc_anti_cd3) ) %>%
  ggplot() +
  geom_line( aes( x = hours_incub, y = count, group = well, col = conc_anti_cd3, linetype = aphidicolin ) )
```

### Aufgabe

Erstellung einer Tabelle, die nur die Zellzahlen zum Zeitpunkt 0 enthält:

```{r}
tbl_counts_at_zero <- counts_per_well %>%
  ungroup() %>%
  filter( hours_incub == 0 ) %>%
  select( -hours_incub, count_at_0 = count) 
tbl_counts_at_zero
```

### Aufgabe

Normalisierung der Daten:

```{r}
counts_per_well %>%
  left_join( tbl_counts_at_zero) %>%
  mutate( norm_count = count / count_at_0 ) -> tbl_normalized
tbl_normalized
```

### Aufgabe

Neuer Plot, nun mit normalisierten Daten:

```{r}
tbl_normalized %>%
  left_join( plate_rows, by = "plate_row" ) %>%
  left_join( plate_cols, by = "plate_column") %>%
  filter( 
    content == "target cells only",
    used = TRUE
    ) %>%
  mutate( well = str_c( plate_row, plate_column ) ) %>%
  mutate( conc_anti_cd3 = as.factor(conc_anti_cd3) ) %>%
  ggplot() +
  geom_line( aes( x = hours_incub, y = norm_count, group = well, col = conc_anti_cd3, linetype = aphidicolin ) )
```

### Aufgabe

Normalisierter Plot, mit log-Skalierung der y-Achse

```{r}
tbl_normalized %>%
  left_join( plate_rows, by = "plate_row" ) %>%
  left_join( plate_cols, by = "plate_column") %>%
  filter( 
    content == "target cells only",
    used = TRUE
    ) %>%
  mutate( well = str_c( plate_row, plate_column ) ) %>%
  mutate( conc_anti_cd3 = as.factor(conc_anti_cd3) ) %>%
  ggplot() +
  geom_line( aes( x = hours_incub, y = norm_count, group = well, col = conc_anti_cd3, linetype = aphidicolin ) ) +
  scale_y_log10()
```

### Aufgabe: Interpretierung

Die Proliferation der Zielzellen wird durch Aphidicolin deutlich gehemmt. Die Zugabe von Anti-CD3 scheint die Zellproliferation nicht zu beeinflussen.

## Kokulturen

### Aufgabe

Nun plotten wir die Daten der Kokulturen, aufgeteilt nach Probanden und der Anzahl der zugegebenen T-Zellen:

```{r}
tbl_normalized %>%
  left_join( plate_rows) %>%
  left_join( plate_cols) %>%
  filter( 
    content == "co-culture",
    used 
    ) %>%
  mutate( well = str_c( plate_row, plate_column ) ) %>%
  mutate( conc_anti_cd3 = as.factor(conc_anti_cd3) ) %>%
  ggplot() +
  geom_line( aes( x = hours_incub, y = norm_count, group = well, col = conc_anti_cd3) ) +
  scale_y_log10() +
  facet_grid( n0_t_cells ~ subject )
```

### Aufgabe: Interpretation

Die Zugabe von Anti-CD3-Antikörpern ist für die Aktivierung der T-Zellen erforderlich. Eine erhöhte Antikörperkonzentration scheint jedoch keinen wesentlichen zusätzlichen Effekt zu haben. Eine Überaktivierung der T-Zellen könnte hingegen einen negativen Einfluss auf die Zytotoxizität haben.

Eine höhere Anzahl von T-Zellen führt zu einer effizienteren Abtötung der Zielzellen. Die Varianz der Abtötungsdynamik ist zwischen den verschiedenen Probanden relativ hoch. So scheinen die T-Zellen des Probanden C3 insgesamt besonders effizient zu sein. Die Abtötungsdynamik des Patienten 1 unterscheidet sich hingegen nicht wesentlich von der der Kontrollen, und seine T-Zellen zeigen *in vitro* eine adäquate Antwort. Der mit diesem Assay gemessene Effekt kann die Symptome des Patienten daher nicht erklären.
